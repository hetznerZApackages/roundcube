commit cceeff2472c00acb2c6b96c9df7a289f1db77713
Author: Aleksander Machniak <alec@alec.pl>
Date:   Sun Apr 26 08:03:59 2020 +0200

    Fix CSRF bypass that could be used to log out an authenticated user (#7302)

---
 index.php |   10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/index.php
+++ b/index.php
@@ -93,7 +93,9 @@ if ($RCMAIL->task == 'login' && $RCMAIL-
     $request_valid = $_SESSION['temp'] && $RCMAIL->check_request();
 
     // purge the session in case of new login when a session already exists
-    $RCMAIL->kill_session();
+    if ($request_valid) {
+        $RCMAIL->kill_session();
+    }
 
     $auth = $RCMAIL->plugins->exec_hook('authenticate', array(
         'host' => $RCMAIL->autoselect_host(),
@@ -168,13 +170,15 @@ if ($RCMAIL->task == 'login' && $RCMAIL-
         $RCMAIL->plugins->exec_hook('login_failed', array(
             'code' => $error_code, 'host' => $auth['host'], 'user' => $auth['user']));
 
-        $RCMAIL->kill_session();
+        if (!isset($_SESSION['user_id'])) {
+            $RCMAIL->kill_session();
+        }
     }
 }
 
 // end session
 else if ($RCMAIL->task == 'logout' && isset($_SESSION['user_id'])) {
-    $RCMAIL->request_security_check($mode = rcube_utils::INPUT_GET);
+    $RCMAIL->request_security_check(rcube_utils::INPUT_GET | rcube_utils::INPUT_POST);
 
     $userdata = array(
         'user' => $_SESSION['username'],
