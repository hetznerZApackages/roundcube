commit 102fbf1169116fef32a940b9fb1738bc45276059
Author: Aleksander Machniak <alec@alec.pl>
Date:   Fri Aug 24 12:29:18 2018 +0200

    Fix CSS issue in handling invalid style tag content (#6410)

---
 program/steps/mail/func.inc |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/program/steps/mail/func.inc
+++ b/program/steps/mail/func.inc
@@ -965,7 +965,8 @@ function rcmail_washtml_callback($tagnam
         }
 
         // decode all escaped entities and reduce to ascii strings
-        $stripped = preg_replace('/[^a-zA-Z\(:;]/', '', rcube_utils::xss_entity_decode($content));
+        $decoded  = rcube_utils::xss_entity_decode($content);
+        $stripped = preg_replace('/[^a-zA-Z\(:;]/', '', $decoded);
 
         // now check for evil strings like expression, behavior or url()
         if (!preg_match('/expression|behavior|javascript:|import[^a]/i', $stripped)) {
@@ -973,7 +974,7 @@ function rcmail_washtml_callback($tagnam
                 $washtml->extlinks = true;
             }
             else {
-                $out = html::tag('style', array('type' => 'text/css'), $content);
+                $out = html::tag('style', array('type' => 'text/css'), $decoded);
             }
             break;
         }
