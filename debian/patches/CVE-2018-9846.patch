---
 plugins/archive/archive.php                  |    6 ++++--
 plugins/managesieve/managesieve.php          |    4 ++--
 plugins/markasjunk/markasjunk.php            |    9 ++++++---
 program/lib/Roundcube/rcube_imap_generic.php |   10 ++++++----
 4 files changed, 18 insertions(+), 11 deletions(-)

--- a/program/lib/Roundcube/rcube_imap_generic.php
+++ b/program/lib/Roundcube/rcube_imap_generic.php
@@ -3836,13 +3836,13 @@ class rcube_imap_generic
 
         if (!is_array($messages)) {
             // if less than 255 bytes long, let's not bother
-            if (!$force && strlen($messages)<255) {
-                return $messages;
+            if (!$force && strlen($messages) < 255) {
+                return preg_match('/[^0-9:,*]/', $messages) ? 'INVALID' : $messages;
             }
 
             // see if it's already been compressed
             if (strpos($messages, ':') !== false) {
-                return $messages;
+                return preg_match('/[^0-9:,*]/', $messages) ? 'INVALID' : $messages;
             }
 
             // separate, then sort
@@ -3877,7 +3877,9 @@ class rcube_imap_generic
         }
 
         // return as comma separated string
-        return implode(',', $result);
+        $result = implode(',', $result);
+
+        return preg_match('/[^0-9:,]/', $result) ? 'INVALID' : $result;
     }
 
     /**
--- a/plugins/archive/archive.php
+++ b/plugins/archive/archive.php
@@ -122,8 +122,10 @@ class archive extends rcube_plugin
       $index = $storage->index(null, rcmail_sort_column(), rcmail_sort_order());
       $messageset = array($current_mbox => $index->get());
     }
-    else {
-      $messageset = rcmail::get_uids();
+    else if (!empty($uids)) {
+      $messageset = rcmail::get_uids($uids, $current_mbox);
+    } else {
+      $messageset = array();
     }
 
     foreach ($messageset as $mbox => $uids) {
--- a/plugins/managesieve/managesieve.php
+++ b/plugins/managesieve/managesieve.php
@@ -190,8 +190,8 @@ class managesieve extends rcube_plugin
     function managesieve_actions()
     {
         // handle fetching email headers for the new filter form
-        if ($uid = rcube_utils::get_input_value('_uid', rcube_utils::INPUT_POST)) {
-            $uids    = rcmail::get_uids();
+        if ($_uid = rcube_utils::get_input_value('_uid', rcube_utils::INPUT_POST)) {
+            $uids    = rcmail::get_uids($_uid);
             $mailbox = key($uids);
             $message = new rcube_message($uids[$mailbox][0], $mailbox);
             $headers = $this->parse_headers($message->headers);
--- a/plugins/markasjunk/markasjunk.php
+++ b/plugins/markasjunk/markasjunk.php
@@ -62,10 +62,13 @@ class markasjunk extends rcube_plugin
 
         $rcmail  = rcmail::get_instance();
         $storage = $rcmail->get_storage();
+        $uids = rcube_utils::get_input_value('_uid', rcube_utils::INPUT_POST);
 
-        foreach (rcmail::get_uids() as $mbox => $uids) {
-            $storage->unset_flag($uids, 'NONJUNK', $mbox);
-            $storage->set_flag($uids, 'JUNK', $mbox);
+        if (!empty($uids)) {
+            foreach (rcmail::get_uids($uids) as $mbox => $uids) {
+                $storage->unset_flag($uids, 'NONJUNK', $mbox);
+                $storage->set_flag($uids, 'JUNK', $mbox);
+            }
         }
 
         if (($junk_mbox = $rcmail->config->get('junk_mbox'))) {
